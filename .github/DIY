cp ./cfg/Custom_Clash.ini ./
file="Custom_Clash.ini"
mainland_file="Custom_Clash_Mainland.ini"

# åœ¨é¦–è¡Œæ’å…¥æ³¨é‡Š
sed -i '1i;https://raw.githubusercontent.com/superpassby/Custom_OpenClash_Rules/refs/heads/main/Custom_Clash.ini' ./Custom_Clash.ini

# åœ¨ [custom] ä¸‹ä¸€è¡Œæ’å…¥ä¸¤è¡Œè§„åˆ™
sed -i '/^\[custom\]/a ruleset=ğŸ¯ è‡ªå®šä¹‰ç›´è¿,https://raw.githubusercontent.com/superpassby/Custom_OpenClash_Rules/refs/heads/main/.github/MyRule/Direct.list,28800' ./Custom_Clash.ini
sed -i '/^\[custom\]/a ruleset=âœˆï¸ è‡ªå®šä¹‰ä»£ç†,https://raw.githubusercontent.com/superpassby/Custom_OpenClash_Rules/refs/heads/main/.github/MyRule/Proxy.list,28800' ./Custom_Clash.ini

# æ›¿æ¢æŒ‡å®šçš„ Speedtest.list åœ°å€
sed -i 's|https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Speedtest/Speedtest.list|https://raw.githubusercontent.com/superpassby/Custom_OpenClash_Rules/refs/heads/main/.github/MyRule/Speedtest.list|' ./Custom_Clash.ini

# è‡ªå®šä¹‰èŠ‚ç‚¹
sed -i '/^custom_proxy_group=.*æ‰‹åŠ¨é€‰æ‹©`select/ s/`\[\]â™»ï¸ è‡ªåŠ¨é€‰æ‹©/`\[\]â™»ï¸ è‡ªåŠ¨é€‰æ‹©`\[\]ğŸ¯ å…¨çƒç›´è¿`\[\]â˜ï¸ CFèŠ‚ç‚¹`\[\]ğŸ‡§ğŸ‡² ç™¾æ…•è¾¾èŠ‚ç‚¹/' ./Custom_Clash.ini
sed -i 's|^\(custom_proxy_group=â™»ï¸ è‡ªåŠ¨é€‰æ‹©`url-test`\).*\(`https://www.gstatic.com/generate_204`300,,50\)$|\1[]ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹`[]ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹`[]ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹`[]ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹`[]ğŸ‡¼ğŸ‡¸ å°æ¹¾èŠ‚ç‚¹`[]ğŸ‡°ğŸ‡· éŸ©å›½èŠ‚ç‚¹\2|' ./Custom_Clash.ini


sed -i '/custom_proxy_group.*åœŸè€³å…¶èŠ‚ç‚¹`url-test`/a custom_proxy_group=ğŸ‡§ğŸ‡² ç™¾æ…•è¾¾èŠ‚ç‚¹`url-test`(ç™¾æ…•è¾¾|BM)`http://91.108.56.138`300,,50' ./Custom_Clash.ini
sed -i '/custom_proxy_group.*åœŸè€³å…¶èŠ‚ç‚¹`url-test`/a custom_proxy_group=â˜ï¸ CFèŠ‚ç‚¹`url-test`(Cloudflare|CF)`http://91.108.56.138`300,,50' ./Custom_Clash.ini

sed -i '/custom_proxy_group.*å…¶ä»–åœ°åŒº/s/æ¸¯|/ç™¾æ…•è¾¾|BM|æ¸¯|Cloudflare|CF|/' ./Custom_Clash.ini
sed -i '/^custom_proxy_group=.*å³æ—¶é€šè®¯`select/ s/`\[\]â™»ï¸ è‡ªåŠ¨é€‰æ‹©/`\[\]â™»ï¸ è‡ªåŠ¨é€‰æ‹©`\[\]ğŸ¯ å…¨çƒç›´è¿`\[\]â˜ï¸ CFèŠ‚ç‚¹`\[\]ğŸ‡§ğŸ‡² ç™¾æ…•è¾¾èŠ‚ç‚¹/' ./Custom_Clash.ini


# sed -i '/^custom_proxy_group=ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§èŠ‚ç‚¹\|^custom_proxy_group=ğŸ‡¬ğŸ‡§ è‹±å›½èŠ‚ç‚¹\|^custom_proxy_group=ğŸ‡«ğŸ‡· æ³•å›½èŠ‚ç‚¹\|^custom_proxy_group=ğŸ‡©ğŸ‡ª å¾·å›½èŠ‚ç‚¹\|^custom_proxy_group=ğŸ‡³ğŸ‡± è·å…°èŠ‚ç‚¹\|^custom_proxy_group=ğŸ‡¹ğŸ‡· åœŸè€³å…¶èŠ‚ç‚¹/ s/^/;/' ./Custom_Clash.ini



# å¢åŠ  è‡ªå®šä¹‰ä»£ç†ã€è‡ªå®šä¹‰ç›´è¿ åˆ—è¡¨
speedtest_line=$(grep -E 'custom_proxy_group.*æµ‹é€Ÿå·¥å…·' "$file")
[ -z "$speedtest_line" ] && { echo "æœªæ‰¾åˆ°æµ‹é€Ÿå·¥å…·è¡Œ"; exit 1; }

#custom_line="${speedtest_line//æµ‹é€Ÿå·¥å…·/è‡ªå®šä¹‰ä»£ç†}"
custom_line=$(echo "$speedtest_line" | sed 's/=.*æµ‹é€Ÿå·¥å…·/=ğŸ¯ è‡ªå®šä¹‰ç›´è¿/')
#direct_line="${speedtest_line//æµ‹é€Ÿå·¥å…·/è‡ªå®šä¹‰ç›´è¿}"
direct_line=$(echo "$speedtest_line" | sed 's/=.*æµ‹é€Ÿå·¥å…·/=âœˆï¸ è‡ªå®šä¹‰ä»£ç†/')

## ç›´æ¥ä¿®æ”¹æ–‡ä»¶
content=""
found=0
while IFS= read -r line; do
    content+="$line"$'\n'
    # åŒ¹é…è‡ªåŠ¨é€‰æ‹©è¡Œåï¼Œåœ¨å…¶ä¸‹æ–¹æ’å…¥ä¸¤è¡Œ
    #if [[ "$line" =~ custom_proxy_group.*è‡ªåŠ¨é€‰æ‹© ]]; then
    if [[ "$line" =~ custom_proxy_group.*è‡ªåŠ¨é€‰æ‹©\`url-test ]]; then
        content+="$custom_line"$'\n'
        content+="$direct_line"$'\n'
        found=1
    fi
done < "$file"

[ "$found" -eq 0 ] && { echo "æœªæ‰¾åˆ°è‡ªåŠ¨é€‰æ‹©è¡Œ"; exit 1; }

## å†™å…¥æ–‡ä»¶
echo "$content" > "$file"
echo "å¤„ç†æˆåŠŸï¼šåœ¨è‡ªåŠ¨é€‰æ‹©è¡Œä¸‹æ–¹æ·»åŠ äº†è‡ªå®šä¹‰ä»£ç†å’Œç›´è¿è§„åˆ™"


# è‡ªå®šä¹‰é¡ºåº
processed_content=""

## å•æ¬¡è¯»å–å¤„ç†æ‰€æœ‰è§„åˆ™
while IFS= read -r line; do
    ### å¤„ç†å³æ—¶é€šè®¯/ç¤¾äº¤åª’ä½“/GitHubç»„
    if [[ "$line" =~ custom_proxy_group.*(è‡ªå®šä¹‰ä»£ç†|å³æ—¶é€šè®¯|ç¤¾äº¤åª’ä½“|GitHub|YouTube|Netflix|DisneyPlus|HBO|PrimeVideo|AppleTV|Spotify|å›½å¤–åª’ä½“|å›½å¤–ç”µå•†|è°·æ­ŒFCM|è°·æ­ŒæœåŠ¡|æ¼ç½‘ä¹‹é±¼) ]]; then
        if [[ "$line" =~ (\`\[\][^\`]*æ‰‹åŠ¨é€‰æ‹©) ]]; then
            manual_select="${BASH_REMATCH[1]}"
            new_line="${line//$manual_select/}"
            if [[ "$new_line" =~ (.*\`select)(.*) ]]; then
                line="${BASH_REMATCH[1]}${manual_select}${BASH_REMATCH[2]}"
            fi
        fi
    ### å¤„ç†AIæœåŠ¡ç»„
    elif [[ "$line" =~ custom_proxy_group.*(ChatGPT|Copilot|AIæœåŠ¡|TikTok) ]]; then
        if [[ "$line" =~ (\`\[\][^\`]*ç¾å›½èŠ‚ç‚¹) ]]; then
            us_node="${BASH_REMATCH[1]}"
            new_line="${line//$us_node/}"
            if [[ "$new_line" =~ (.*\`select)(.*) ]]; then
                line="${BASH_REMATCH[1]}${us_node}${BASH_REMATCH[2]}"
            fi
        fi
    fi
    
    processed_content+="$line"$'\n'
done < "$file"

## å®‰å…¨å†™å…¥æ–‡ä»¶
{
    printf "%s" "$processed_content" > "$file"
    echo "å¤„ç†å®Œæˆï¼Œå…±å¤„ç†äº† ${#processed_content} å­—èŠ‚"
} || {
    echo "å†™å…¥æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™" >&2
    exit 1
}

# ç”Ÿæˆ "Custom_Clash_Mainland.ini"

## æ‰§è¡Œæ›¿æ¢å¹¶å†™å…¥æ–°æ–‡ä»¶
sed 's|https://raw.githubusercontent.com|https://gh-proxy.com/https://raw.githubusercontent.com|g' \
    "$file" > "$mainland_file"
